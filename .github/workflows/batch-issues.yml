      - name: Create labels and issues (GitHub API)
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const payload = JSON.parse(fs.readFileSync('issues.json','utf8'));

            // Accept either a flat array or { milestone, defaults, issues:[...] }
            let items = [];
            let milestoneTitle = null;
            let defaultLabels = [];
            let defaultAssignees = [];

            if (Array.isArray(payload)) {
              items = payload;
            } else if (payload && payload.issues && Array.isArray(payload.issues)) {
              milestoneTitle   = payload.milestone || null;
              defaultLabels    = Array.isArray(payload.defaults?.labels) ? payload.defaults.labels : [];
              defaultAssignees = Array.isArray(payload.defaults?.assignees) ? payload.defaults.assignees : [];
              items = payload.issues.map(it => {
                const lbls = [...new Set([...(it.labels || []), ...defaultLabels])];
                let body = it.body || "";
                if (Array.isArray(it.acceptance_criteria) && it.acceptance_criteria.length) {
                  body += "\n\nAcceptance\n- " + it.acceptance_criteria.join("\n- ");
                }
                const assignees = Array.isArray(it.assignees) ? it.assignees : defaultAssignees;
                return { title: it.title, body, labels: lbls, assignees };
              });
            } else {
              core.setFailed("Issues file must be an array or {milestone, defaults, issues:[...] }.");
              return;
            }

            core.info(`Found ${items.length} issues in batch`);

            // Ensure labels exist (standard + custom)
            const std = [
              "severity:critical","severity:high","severity:medium","severity:low",
              "area:scheduler","area:infra","area:reminders","area:data","area:commands","area:ops","area:devx",
              "type:bug","type:perf","type:hardening","type:security","type:tooling"
            ];
            const custom = [...new Set(items.flatMap(i => i.labels || []))].filter(x => !std.includes(x));
            const allLabels = [...new Set([...std, ...custom])];

            for (const name of allLabels) {
              try {
                await github.rest.issues.createLabel({
                  owner: context.repo.owner, repo: context.repo.repo,
                  name, color: "cccccc", description: name
                });
                core.info(`Created label: ${name}`);
              } catch (e) {
                if (e.status === 422) {
                  core.info(`Label exists: ${name}`);
                } else {
                  core.warning(`Label "${name}" error: ${e.message}`);
                }
              }
            }

            // Optional milestone
            let milestoneNumber = undefined;
            if (milestoneTitle) {
              const list = await github.rest.issues.listMilestones({
                owner: context.repo.owner, repo: context.repo.repo, state: "open"
              });
              const found = list.data.find(m => m.title === milestoneTitle);
              if (found) milestoneNumber = found.number;
              else {
                const created = await github.rest.issues.createMilestone({
                  owner: context.repo.owner, repo: context.repo.repo, title: milestoneTitle
                });
                milestoneNumber = created.data.number;
              }
            }

            // Create issues
            for (const it of items) {
              await github.rest.issues.create({
                owner: context.repo.owner, repo: context.repo.repo,
                title: it.title || "(missing title)",
                body: it.body || "",
                labels: it.labels || [],
                assignees: it.assignees || [],
                milestone: milestoneNumber
              });
            }
